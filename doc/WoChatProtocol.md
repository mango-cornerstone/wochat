# WoChat消息的加密规范


本文档论述WoChat加密明文的规范。

假设我们要发送的明文数据有n个字节，可以使用如下C语言变量来表示：

```c
unsinged char message[n];
```

如果n小于252个字节，我们就构造一个252字节的随机数据包，把明文数据放入这个随机数据包中。我们需要有两个变量来标记明文在这个252字节中的位置：长度n和偏移量offset。n的取值范围是1到251。offset的取值范围是0到252 - n。 为什么选择252呢？目的是为了让整体的长度是3的倍数，经过base64编码后就不存在补齐的等号(=)了。

如果n大于等于252个字节，则不需要上面的凑齐操作，则offset恒定为0。

经过上面处理的明文，如何进行加密呢？ 首先我们产生一个32字节的随机数，作为会话密钥K0。所谓会话密钥，就是每次加密都选择不同的密钥。上述明文采用Chacha20流加密的技术进行加密，密钥就是K0。很显然K0是需要随着加密后的密文一起传送给接受者的，所以我们必须要对K0进行加密。对K0加密所使用的算法是AES256，所使用的密钥是K，32个字节。 K是由发送方的私钥sK1和接受方的公钥pK2计算出来的，同时，接受方的私钥sK2和发送方的公钥pK1也可以计算出K。 其中sK表示secret Key，pK表示public Key。 我们把K成为主密钥。一个发送者和一个接受者所使用的主密钥K是固定不变的。

这是椭圆曲线算法的重要特点。WoChat就是利用这个机制，在发送者无需向接受者传递K的情况下，依然可以完成加密和解密的操作。下面的公式展示了主密钥K的基本规律：

```
K = f(sK1, pK2)
K = f(sK2, pK1)
```


总结一下，真正的数据使用Chacha20流加密技术，一次一密，会话密钥K0是32字节的随机数。 K0由AES256算法进行加密，密钥K是利用椭圆曲线的公钥和私钥计算出来的，因为双方都可以计算出相同的K，所以K无需传递，窃听者就无从窃听。

以上就是WoChat加密规范的基本思想。 在理解了基本思想后，我们来看看WoChat加密消息包的具体格式。


WoChat消息包分为三种类型，包含真正数据的普通消息包、收到消息的确认消息包和要求撤销消息的请求消息包。下面依次论述这三种不同类型的消息包。

## 包含真正数据的普通消息包

在WoChat通讯过程中，这种消息包属于最常见的类型，因为其中包含通讯双方真正想交流的数据。这些数据可以是文本，也可以是图片、视频等二进制信息。 这种消息包的规范可以用下图表示。

![](x0001.svg) 

如图所示，整个消息包分为三部分，下面介绍每一个部分的内容。

### 消息包的第一部分

消息包的第一部分就是头66个字节。它记录着发送者的公钥的字符串。因为椭圆曲线公钥是33个字节，变成人可读的字符串就是66个字节，譬如一个字节0xA3变成了'A3'，这是两个字节。所以33个字节的原始公钥变成人可读的形式，就是66个字节。 接受者的公钥就是接收到数据包的MQTT的主题(topic)，所以消息包中不包含接受者的公钥，只包含发送者的公钥。虽然任何人都可以在接受者的公钥的topic上接收消息包，但是只有拥有接受者公钥对应的私钥的人才可以解开消息包，所以不怕别人偷听。

### 消息包的第二部分
就是消息包的第67个字符，它固定是竖线符号|，表示和后面的数据包的分隔符。从第68个字节开始到最后，都是base64编码的数据。

### 消息包的第三部分

从第68个字节开始到消息包的最后，都是base64编码的数据。这些数据是消息包的第三部分。

base64编码的数据经过base64解码后，分为五个域。头四个域的长度是固定的，分别是32字节，4字节，4字节和32字节。第五个域保存真正的数据，它的长度n是可变的，最小是252个字节。MQTT消息包的最大长度是256MB，所以n的最大值大约是256MB，扣除在它前面的字节的开销。

除了第一个域以外，后面四个域的数据都是经过Chacha20流加密算法加密的。所以你必须先用Chacha20进行解密，才能够解读里面的内容。解密的密钥K0是32个字节，保存在第一个域中。K0又是被主密钥K使用AES256加密算法加密的。K是由发送方的私钥sK1和接受方的公钥pK2计算出来的。

这五个域的含义分别论述如下。
#### 第一个域

第一个域是头32个字节，保存会话密钥K0。当然K0是经过主密钥K使用AES256加密算法加密的。

#### 第二个域
第二个域是第一个域随后紧挨的4个字节。它记录后面真正数据包的长度。该域按照小端格式(little-endian)存放。譬如长度是1193046个字节，就是十六进制的0x123456。则这个域的四个字节中，第一个字节保存56，第二个字节保存34，第三个字节保存12，第四个字节保存0。

#### 第三个域
第三个域是第二个域随后紧挨的4个字节。这四个字节目前只使用了头3个字节，最后一个字节保留供未来使用。 这个域的第一个字节，表示加密规范的版本，目前恒定为1。 第二个字节表示后面的数据的类型。T表示文本类型，不是T则表示二进制类型，譬如图片或者视频等信息。这个字节的取值可以是：
- T 表示文本
- G 表示GIF格式的图片
- P 表示PNG格式的图片
- J 表示Jpeg格式的图片
- B 表示BMP格式的图片
- M 表示MP4的视频
- m 表示mp3格式的音频
- S 表示SWF格式专用的教育视频格式

这个列表还可以继续扩充。这部分未来会进一步规范。

第三个字节表示真正的数据在后面n个字节中的偏移量。如果真正的数据大于等于252，则这个字节的值恒定为0。 如果真正的数据长度n小于252，则这个字节的取值范围是0到252 - n 。

第四个字节保留未用，供将来使用。

#### 第四个域
第四个域是32字节，表示真正数据的SHA256的哈希值。 如果明文的长度是52个字节，它保存在252字节的随机数据包中，偏移量的取值范围是0到200。 这该域计算的是52个字节的SHA256哈希值，不包括那些随机填充的数据。

#### 第五个域

第五个域就是真正的数据了，它的长度为n。前面已经讲过了，如果发送的消息长度小于252字节，则真正的数据包包含在一个252字节的随机数据包中。所以n的最小值为252。 由于汉字在UTF16下通常是2个字节，在UTF8下是3个字节，为了节省流量，真正的文本数据采用UTF16编码。对于图片视频等二进制文件，就不存在编码的问题了，该是啥就是啥。

## 确认消息包

当接收方收到普通消息包后，会对消息包进行解密和验证。验证的工作就是比对实际内容和消息包头的SHA256值是否相等，这个值是32个字节。 每一个消息都有一个独一无二的SHA256值。 当校验无误后，接收方会向发送方发送一个确认消息包。这种消息包的格式可以用下图表示：

![](x0002.svg) 

这种消息包格式很简单，共计131个字节。头66个字节是接受者的公钥，中间一个加号，再后面64个字节表示解密后的消息的SHA256值。 发送者拿到这个消息包后，和自己发送的消息的SHA256进行校验后，就可以知道接受者的的确确收到了自己的消息，他可以在界面上做一些标记，譬如在消息的右上角加上一个勾号，知道对方的的确确收到了自己的消息。

## 请求消息包

发送者发送消息后，在一定时间内，譬如30秒之内，突然后悔了，想撤回自己发送的消息，就向接受者发送如下格式的消息包。但是接受者是否接受撤回，由接受者说了算。譬如接受者编译WoChat源码时禁止撤回消息功能。 所以这个消息包仅供接受者参考，是否撤回的权力在接受者。

![](x0003.svg) 

这种消息包格式很简单，共计131个字节。头66个字节是发送者的公钥，中间一个减号，再后面64个字节表示解密后的消息的SHA256值。 接受者拿到这个消息包后，和自己接受到的消息解密后的SHA256进行校验后，就可以知道发送者要求撤销哪个消息包。 是否撤销的动作由接受者说了算。


## 意见反馈

有任何问题，请发信到wochatdb@gmail.com



