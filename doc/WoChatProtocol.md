# WoChat消息协议规范

WoChat消息包的规范非常简单。如下图所示：

![](x0001.svg) 

消息包的头66个字节是发送者的公钥的字符串。因为椭圆曲线公钥是33个字节，变成人可读的字符串就是66个字节，譬如一个字节0xA3变成了'A3'，这是两个字节。
第67个字符是|，表示和后面的数据包的分隔符。从第68个字节开始到最后，都是base64编码的数据。

base64编码的数据经过base64解码后，分为3个域。所有这3个域的数据都是经过Chacha20流加密算法加密的。所以你必须先用Chacha20进行解密。加密的密钥是对方私钥和我方公钥计算的32个字节。我方私钥和对方公钥也可以计算出这个密钥，所以密钥不需要传递。

这3个域的含义如下：
- 头4个字节表示真正数据包的长度，不包括紧挨着的32个字节。如果真正的数据是n个字节，这个长度信息的值是n。MQTT最大包的长度是268435456字节，即256MB，4个字节可以表示4GB，所以长度信息足够了。
- 紧挨着的32个字节表示后面真正数据的SHA256的哈希值。通过对比哈希值，可以确定后面的数据包是否损坏或者被篡改。
- 再后面就是真正的数据了，长度不等。

因为汉字在UTF16下通常是2个字节，在UTF8下是3个字节，为了节省流量，真正的文本数据采用UTF16编码。对于图片视频等二进制文件，就不存在编码的问题了，该是啥就是啥。
假设你要发送一个文本消息：a。它在UTF16中占有2个字节，所以消息包的最小长度是$ + 32 + 2 = 38，变成base64编码后，长度为52。再加上前面的67个字节，共计119个字节。再考虑最后添加一个0作为结尾，一个文本消息包的最小长度是120个字节。

有任何问题，请发信到wochatdb@gmail.com



